<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Payslip Viewer</title>
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Payslip Viewer</h1>
        
        {% if is_admin %}
        <div class="section">
            <h2>Upload PDF</h2>
            <form id="uploadForm">
                <label for="uploadMonth">Select Month:</label>
                <input type="month" id="uploadMonth" required>
                <input type="file" id="pdfFile" accept=".pdf" required>
                <button type="submit">Upload PDF</button>
            </form>
            <div id="uploadStatus"></div>
        </div>
        {% endif %}
        
        <div class="section">
            <h2>View Payslip</h2>
            <form id="viewForm" onsubmit="return false;">
                <label for="viewMonth">Select Month:</label>
                <select id="viewMonth" required>
                    <option value="">Loading months...</option>
                </select>
                <input type="text" id="idNumber" placeholder="Enter your ID Number" required>
                <button type="submit">View Payslip</button>
            </form>
            <div id="viewStatus"></div>
            <iframe id="payslipViewer" style="display: none; width: 100%; height: 600px; border: 2px solid #ddd; border-radius: 8px; margin-top: 20px;"></iframe>
        </div>
    </div>

    <script>
        // Mobile optimizations
        // Prevent double-tap zoom on buttons
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // Prevent zoom on input focus (but allow pinch zoom for PDF)
        const inputs = document.querySelectorAll('input[type="text"], input[type="month"], select');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                if (window.innerWidth < 768) {
                    const viewport = document.querySelector('meta[name="viewport"]');
                    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                }
            });
            
            input.addEventListener('blur', function() {
                const viewport = document.querySelector('meta[name="viewport"]');
                viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes');
            });
        });
        
        // Load available months on page load
        async function loadMonths() {
            try {
                const response = await fetch('/months');
                const data = await response.json();
                const monthSelect = document.getElementById('viewMonth');
                
                if (data.months && data.months.length > 0) {
                    monthSelect.innerHTML = '<option value="">Select a month...</option>';
                    data.months.forEach(month => {
                        const [year, monthNum] = month.split('-');
                        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                          'July', 'August', 'September', 'October', 'November', 'December'];
                        const monthName = monthNames[parseInt(monthNum) - 1];
                        const option = document.createElement('option');
                        option.value = month;
                        option.textContent = `${monthName} ${year}`;
                        monthSelect.appendChild(option);
                    });
                } else {
                    monthSelect.innerHTML = '<option value="">No months available - upload a PDF first</option>';
                }
            } catch (error) {
                console.error('Error loading months:', error);
                document.getElementById('viewMonth').innerHTML = '<option value="">Error loading months</option>';
            }
        }
        
        // Load months when page loads
        loadMonths();
        
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            const monthInput = document.getElementById('uploadMonth');
            const monthValue = monthInput.value; // Format: YYYY-MM
            
            if (!monthValue) {
                document.getElementById('uploadStatus').innerHTML = '<p class="error">✗ Please select a month</p>';
                return;
            }
            
            formData.append('pdf', document.getElementById('pdfFile').files[0]);
            formData.append('month', monthValue);
            formData.append('admin_key', 'admin123'); // Admin secret key
            
            const statusDiv = document.getElementById('uploadStatus');
            const submitBtn = e.target.querySelector('button');
            const originalText = submitBtn.textContent;
            
            statusDiv.innerHTML = '<p class="loading">Uploading and processing PDF...</p>';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = `<p class="success">✓ ${data.message}</p>`;
                    // Reload months list
                    loadMonths();
                    // Reset form
                    document.getElementById('uploadForm').reset();
                } else {
                    statusDiv.innerHTML = `<p class="error">✗ ${data.error}</p>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<p class="error">✗ Upload failed: ${error.message}</p>`;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
        
        // Ensure form handler is attached after page loads
        function attachViewFormHandler() {
            const viewForm = document.getElementById('viewForm');
            if (!viewForm) {
                console.error('View form not found');
                return;
            }
            
            // Remove any existing listeners
            const newForm = viewForm.cloneNode(true);
            viewForm.parentNode.replaceChild(newForm, viewForm);
            
            newForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const idNumber = document.getElementById('idNumber').value.trim();
                const month = document.getElementById('viewMonth').value;
                
                if (!month) {
                    document.getElementById('viewStatus').innerHTML = '<p class="error">✗ Please select a month</p>';
                    return false;
                }
                
                if (!idNumber) {
                    document.getElementById('viewStatus').innerHTML = '<p class="error">✗ Please enter your ID number</p>';
                    return false;
                }
                
                const statusDiv = document.getElementById('viewStatus');
                const viewer = document.getElementById('payslipViewer');
                const submitBtn = newForm.querySelector('button');
                const originalText = submitBtn.textContent;
                
                statusDiv.innerHTML = '<p class="loading">Loading payslip...</p>';
                viewer.style.display = 'none';
                submitBtn.disabled = true;
                submitBtn.textContent = 'Loading...';
                
                try {
                    console.log('Fetching payslip for ID:', idNumber, 'Month:', month);
                    const response = await fetch('/view', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ id_number: idNumber, month: month })
                    });
                    
                    console.log('Response status:', response.status);
                    console.log('Response content-type:', response.headers.get('content-type'));
                    
                    // Check content type
                    const contentType = response.headers.get('content-type') || '';
                    
                    if (response.ok && contentType.includes('application/pdf')) {
                        const blob = await response.blob();
                        console.log('PDF blob size:', blob.size);
                        const url = URL.createObjectURL(blob);
                        viewer.src = url;
                        viewer.style.display = 'block';
                        statusDiv.innerHTML = '';
                        console.log('Payslip displayed successfully');
                    } else if (response.ok) {
                        // Not a PDF, might be an error message
                        const text = await response.text();
                        console.log('Non-PDF response:', text);
                        try {
                            const data = JSON.parse(text);
                            statusDiv.innerHTML = `<p class="error">✗ ${data.error || 'Unknown error'}</p>`;
                        } catch {
                            statusDiv.innerHTML = `<p class="error">✗ Unexpected response format</p>`;
                        }
                    } else {
                        // Error response
                        const text = await response.text();
                        console.log('Error response:', text);
                        try {
                            const data = JSON.parse(text);
                            statusDiv.innerHTML = `<p class="error">✗ ${data.error || 'Error loading payslip'}</p>`;
                        } catch {
                            statusDiv.innerHTML = `<p class="error">✗ Error: ${response.status} ${response.statusText}</p>`;
                        }
                    }
                } catch (error) {
                    console.error('View payslip error:', error);
                    statusDiv.innerHTML = `<p class="error">✗ Error: ${error.message}. Please check your connection and try again.</p>`;
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
                
                return false;
            });
        }
        
        // Attach handler when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', attachViewFormHandler);
        } else {
            attachViewFormHandler();
        }
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Payslip Viewer</title>
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Payslip Viewer</h1>
        
        {% if is_admin %}
        <div class="section">
            <h2>Upload PDF</h2>
            <form id="uploadForm">
                <label for="uploadMonth">Select Month:</label>
                <input type="month" id="uploadMonth" required>
                <input type="file" id="pdfFile" accept=".pdf" required>
                <button type="submit">Upload PDF</button>
            </form>
            <div id="uploadStatus"></div>
        </div>
        {% endif %}
        
        <div class="section">
            <h2>View Payslip</h2>
            <form id="viewForm">
                <label for="viewMonth">Select Month:</label>
                <select id="viewMonth" required>
                    <option value="">Loading months...</option>
                </select>
                <input type="text" id="idNumber" placeholder="Enter your ID Number" required>
                <button type="submit">View Payslip</button>
            </form>
            <div id="viewStatus"></div>
            <div id="payslipContainer" style="display: none; margin-top: 20px;">
                <div style="text-align: center; margin-bottom: 10px;">
                    <a id="openLink" href="#" target="_blank" style="display: inline-block; padding: 12px 24px; background: #667eea; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; margin-right: 10px;">Open in New Tab</a>
                    <a id="downloadLink" href="#" download="payslip.pdf" style="display: inline-block; padding: 12px 24px; background: #28a745; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">Download</a>
                </div>
                <iframe id="payslipViewer" style="width: 100%; min-height: 600px; height: calc(100vh - 400px); border: 2px solid #ddd; border-radius: 8px; background: #f8f9fa;"></iframe>
            </div>
        </div>
    </div>

    <script>
        // Load months
        async function loadMonths() {
            try {
                const response = await fetch('/months');
                const data = await response.json();
                const monthSelect = document.getElementById('viewMonth');
                if (!monthSelect) return;
                
                if (data.months && data.months.length > 0) {
                    monthSelect.innerHTML = '<option value="">Select a month...</option>';
                    data.months.forEach(month => {
                        const [year, monthNum] = month.split('-');
                        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                          'July', 'August', 'September', 'October', 'November', 'December'];
                        const monthName = monthNames[parseInt(monthNum) - 1];
                        const option = document.createElement('option');
                        option.value = month;
                        option.textContent = `${monthName} ${year}`;
                        monthSelect.appendChild(option);
                    });
                } else {
                    monthSelect.innerHTML = '<option value="">No months available - upload a PDF first</option>';
                }
            } catch (error) {
                console.error('Error loading months:', error);
            }
        }
        
        // Upload form handler
        const uploadForm = document.getElementById('uploadForm');
        if (uploadForm) {
            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData();
                const monthValue = document.getElementById('uploadMonth').value;
                if (!monthValue) {
                    document.getElementById('uploadStatus').innerHTML = '<p class="error">✗ Please select a month</p>';
                    return;
                }
                
                formData.append('pdf', document.getElementById('pdfFile').files[0]);
                formData.append('month', monthValue);
                formData.append('admin_key', 'admin123');
                
                const statusDiv = document.getElementById('uploadStatus');
                const submitBtn = e.target.querySelector('button');
                const originalText = submitBtn.textContent;
                
                statusDiv.innerHTML = '<p class="loading">Uploading...</p>';
                submitBtn.disabled = true;
                submitBtn.textContent = 'Uploading...';
                
                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        statusDiv.innerHTML = `<p class="success">✓ ${data.message}</p>`;
                        loadMonths();
                        uploadForm.reset();
                    } else {
                        statusDiv.innerHTML = `<p class="error">✗ ${data.error}</p>`;
                    }
                } catch (error) {
                    statusDiv.innerHTML = `<p class="error">✗ Upload failed: ${error.message}</p>`;
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            });
        }
        
        // View form handler
        const viewForm = document.getElementById('viewForm');
        if (viewForm) {
            viewForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const idNumber = document.getElementById('idNumber').value.trim();
                const month = document.getElementById('viewMonth').value;
                
                if (!month || !idNumber) {
                    document.getElementById('viewStatus').innerHTML = '<p class="error">✗ Please select a month and enter your ID number</p>';
                    return;
                }
                
                const statusDiv = document.getElementById('viewStatus');
                const container = document.getElementById('payslipContainer');
                const viewer = document.getElementById('payslipViewer');
                const downloadLink = document.getElementById('downloadLink');
                const openLink = document.getElementById('openLink');
                const submitBtn = e.target.querySelector('button');
                const originalText = submitBtn.textContent;
                
                statusDiv.innerHTML = '<p class="loading">Loading payslip...</p>';
                container.style.display = 'none';
                submitBtn.disabled = true;
                submitBtn.textContent = 'Loading...';
                
                try {
                    const response = await fetch('/view', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id_number: idNumber, month: month })
                    });
                    
                    const contentType = response.headers.get('content-type') || '';
                    
                    if (response.ok && contentType.includes('application/pdf')) {
                        const blob = await response.blob();
                        if (blob.size === 0) {
                            statusDiv.innerHTML = '<p class="error">✗ Received empty PDF</p>';
                            return;
                        }
                        
                        const url = URL.createObjectURL(blob);
                        viewer.src = url;
                        openLink.href = url;
                        downloadLink.href = url;
                        downloadLink.download = `payslip_${idNumber}_${month}.pdf`;
                        
                        container.style.display = 'block';
                        statusDiv.innerHTML = '<p class="success">✓ Payslip loaded!</p>';
                    } else {
                        const text = await response.text();
                        try {
                            const data = JSON.parse(text);
                            statusDiv.innerHTML = `<p class="error">✗ ${data.error}</p>`;
                        } catch {
                            statusDiv.innerHTML = `<p class="error">✗ Error loading payslip</p>`;
                        }
                    }
                } catch (error) {
                    statusDiv.innerHTML = `<p class="error">✗ Error: ${error.message}</p>`;
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            });
        }
        
        // Initialize
        loadMonths();
    </script>
</body>
</html>
